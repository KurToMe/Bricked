var PaddleAi,bricked,__bind=function(a,b){return function(){return a.apply(b,arguments)}};bricked={},bricked.stats=new Stats,document.body.appendChild(bricked.stats.domElement),bricked.canvas=document.getElementById("c"),bricked.ctx=bricked.canvas.getContext("2d"),bricked.SCALE=30,bricked.FRAME_RATE=1/60,bricked.VELOCITY_ITERATIONS=10,bricked.POSITION_ITERATIONS=10,bricked.GRAVITY=new Box2D.Common.Math.b2Vec2(0,0),bricked.WIDTH=bricked.canvas.width,bricked.HEIGHT=bricked.canvas.height,bricked.BALL_RADIUS=10,bricked.paths={},bricked.paths.TRAINER_WORKER="scripts/trainerWorker.js",bricked.getCurrentTime=function(){var a;return a=new Date,a.getTime()},bricked.scaleToPhys=function(a){return a/bricked.SCALE},bricked.scaleVecToPhys=function(a){return a.Multiply(1/bricked.SCALE),a},bricked.scaleToScreen=function(a){return a*bricked.SCALE},bricked.applyXForce=function(a,b){var c,d,e;return c=Box2D.Common.Math.b2Vec2,d=a.GetPosition(),e=new c(b,0),a.ApplyForce(e,d)},bricked.applyYForce=function(a,b){var c,d,e;return c=Box2D.Common.Math.b2Vec2,d=a.GetPosition(),e=new c(0,b),a.ApplyForce(e,d)},bricked.TRAINING_DATA_SIZE=1e3,bricked.PADDLE_X_FORCE=10,bricked.TRAINING_OFFSET=bricked.scaleToPhys(bricked.WIDTH),bricked.TRAINING_SCALE=bricked.TRAINING_OFFSET*2,bricked.MAX_PREDICTIONS=200,bricked.MARGIN=.1,bricked.X_POS=0,bricked.PADDLE_POS=1,bricked.RELATIVE_POS=2,bricked.VX_POS=3,PaddleAi=function(){function a(a){this.paddle=a,this.onTrainerWorkerMessage=__bind(this.onTrainerWorkerMessage,this),this.trainingWorker=new Worker(bricked.paths.TRAINER_WORKER),this.trainingWorker.onmessage=this.onTrainerWorkerMessage,this.trainedLearner=new brain.NeuralNetwork,this.trainingData=[],this.recentData=[],this.isWaitingForWorker=!1,this.isTrained=!1,this.wasRecentDataTrained=!1}return a.prototype.beginContact=function(a){var b,c;b=a.GetFixtureA().GetBody(),c=a.GetFixtureB().GetBody();if(b===bricked.ball||c===bricked.ball)this.recentData=[],b!==this.paddle&&c!==this.paddle},a.prototype.onTrainerWorkerMessage=function(a){return this.trainedLearner.fromJSON(a.data),this.isWaitingForWorker=!1,this.isTrained=!0,console.log("Got prediction function")},a.prototype.applyXForce=function(a){return bricked.applyXForce(this.paddle,a)},a.prototype.moveLeft=function(){return this.applyXForce(-1*bricked.PADDLE_X_FORCE)},a.prototype.moveRight=function(){return this.applyXForce(bricked.PADDLE_X_FORCE)},a.prototype.scaleToTraining=function(a){return(a+bricked.TRAINING_OFFSET)/bricked.TRAINING_SCALE},a.prototype.scaleFromTraining=function(a){return a*bricked.TRAINING_SCALE-bricked.TRAINING_OFFSET},a.prototype.buildCurrentBallData=function(){var a,b,c,d,e,f,g,h,i,j;return b=bricked.ball.GetPosition(),a=bricked.ball.GetLinearVelocity(),f=this.paddle.GetPosition(),g=f.x-b.x,h=b.y-f.y,d=0,e=0,g<0?d=Math.abs(g):e=g,i=0,j=0,a.x<0?i=Math.abs(a.x):j=a.x,c=[this.scaleToTraining(b.x),this.scaleToTraining(f.x),this.scaleToTraining(d),this.scaleToTraining(e),this.scaleToTraining(i),this.scaleToTraining(j)],c},a.prototype.updateTraining=function(){if(this.trainingData.length>bricked.TRAINING_DATA_SIZE){console.log("Training full");return}Math.random()>.5&&this.recentData.push(this.buildCurrentBallData()),this.recentData.length>bricked.TRAINING_DATA_SIZE&&this.recentData.shift(),this.prevBallPos=bricked.ball.GetPosition(),this.prevBallVelocity=bricked.ball.GetLinearVelocity();if(bricked.ball.GetPosition().y>this.paddle.GetPosition().y+.1)return this.trainRecentData()},a.prototype.ballDied=function(){return this.wasRecentDataTrained=!1},a.prototype.trainRecentData=function(){var a,b,c,d,e,f,g,h,i;if(this.isWaitingForWorker||this.wasRecentDataTrained)return;this.wasRecentDataTrained=!0,a=0;while(this.recentData.length>0){a++;if(a>5)break;d=this.recentData.shift(),e=0,f=0,h=0,b=bricked.ball.GetPosition().x,c=this.scaleFromTraining(d[bricked.PADDLE_POS]),g=.2,Math.abs(b-c)<g?h=1:b<c?e=1:f=1,i={input:d,output:{left:e,right:f,stay:h}},this.trainingData.push(i)}return console.log("Sending data to training worker"),this.isWaitingForWorker=!0,this.trainingWorker.postMessage(this.trainingData)},a.prototype.update=function(){var a,b;this.updateTraining();if(this.isTrained){a=this.buildCurrentBallData(),b=this.trainedLearner.run(a);if(!(b.stay>b.right&&b.stay>b.left))return b.left>b.right?this.moveLeft():this.moveRight()}},a}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){return window.setTimeout(a,1e3/60)}}(),bricked.createWalls=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;return b=Box2D.Dynamics.b2BodyDef,a=Box2D.Dynamics.b2Body,c=Box2D.Dynamics.b2FixtureDef,d=Box2D.Collision.Shapes.b2PolygonShape,h=new c,h.density=1,h.friction=0,h.restitution=.2,e=new b,e.type=a.b2_staticBody,h.shape=new d,e.position.x=0,e.position.y=bricked.scaleToPhys(bricked.HEIGHT/2),j=bricked.scaleToPhys(5),i=bricked.scaleToPhys((bricked.HEIGHT+10*bricked.BALL_RADIUS)/2),h.shape.SetAsBox(j,i),bricked.leftWall=bricked.world.CreateBody(e),bricked.leftWall.CreateFixture(h),e.position.x=bricked.scaleToPhys(bricked.WIDTH/2),e.position.y=0,n=bricked.scaleToPhys(bricked.WIDTH/2),m=bricked.scaleToPhys(5),h.shape.SetAsBox(n,m),bricked.world.CreateBody(e).CreateFixture(h),e.position.x=bricked.scaleToPhys(bricked.WIDTH),e.position.y=bricked.scaleToPhys(bricked.HEIGHT/2),l=j,k=i,h.shape.SetAsBox(l,i),bricked.world.CreateBody(e).CreateFixture(h),e.position.x=bricked.scaleToPhys(bricked.WIDTH/2),e.position.y=bricked.scaleToPhys(bricked.HEIGHT+5*bricked.BALL_RADIUS),g=n,f=m,h.shape.SetAsBox(g,m),bricked.bottomWall=bricked.world.CreateBody(e),bricked.bottomWall.CreateFixture(h)},bricked.createBall=function(){var a,b,c,d,e,f,g,h;return b=Box2D.Dynamics.b2BodyDef,a=Box2D.Dynamics.b2Body,d=Box2D.Dynamics.b2FixtureDef,c=Box2D.Collision.Shapes.b2CircleShape,g=new d,g.density=1,g.friction=0,g.restitution=1.1,h=bricked.scaleToPhys(bricked.BALL_RADIUS),g.shape=new c(h),f=new b,f.type=a.b2_dynamicBody,f.position.x=bricked.scaleToPhys(bricked.WIDTH/2),f.position.y=bricked.scaleToPhys(bricked.HEIGHT/2),e=bricked.world.CreateBody(f),e.CreateFixture(g),e.SetBullet(!0),e},bricked.createPaddle=function(){var a,b,c,d,e,f,g,h,i,j;return e=Box2D.Common.Math.b2Vec2,b=Box2D.Dynamics.b2BodyDef,a=Box2D.Dynamics.b2Body,c=Box2D.Dynamics.b2FixtureDef,d=Box2D.Collision.Shapes.b2PolygonShape,g=new c,g.density=1,g.friction=0,g.restitution=1,g.shape=new d,i=[bricked.scaleVecToPhys(new e(0,0)),bricked.scaleVecToPhys(new e(-40,0)),bricked.scaleVecToPhys(new e(-35,-4)),bricked.scaleVecToPhys(new e(-20,-8)),bricked.scaleVecToPhys(new e(-10,-10)),bricked.scaleVecToPhys(new e(10,-10)),bricked.scaleVecToPhys(new e(20,-8)),bricked.scaleVecToPhys(new e(35,-4)),bricked.scaleVecToPhys(new e(40,0))],g.shape.SetAsArray(i,i.Length),f=new b,f.type=a.b2_dynamicBody,f.position.x=bricked.scaleToPhys(bricked.WIDTH/2),f.position.y=bricked.scaleToPhys(bricked.HEIGHT-20),f.linearDamping=2,h=bricked.world.CreateBody(f),h.CreateFixture(g),j=new Box2D.Dynamics.Joints.b2PrismaticJointDef,j.Initialize(h,bricked.bottomWall,h.GetPosition(),new e(1,0)),bricked.world.CreateJoint(j),h},bricked.beginContact=function(a){var b,c;bricked.paddleAi.beginContact(a),b=a.GetFixtureA().GetBody(),c=a.GetFixtureB().GetBody();if(b===bricked.ball||c===bricked.ball){if(b===bricked.paddle||c===bricked.paddle)bricked.ballStartTime=bricked.getCurrentTime();if(b===bricked.bottomWall||c===bricked.bottomWall)return bricked.didBallDie=!0}},bricked.init=function(){var a,b,c,d;return b=Box2D.Dynamics.b2DebugDraw,a=!0,bricked.world=new Box2D.Dynamics.b2World(bricked.GRAVITY,a),bricked.createWalls(),bricked.ball=bricked.createBall(),bricked.paddle=bricked.createPaddle(),bricked.paddleAi=new PaddleAi(bricked.paddle,bricked.ball),d=new Box2D.Dynamics.b2ContactListener,d.BeginContact=bricked.beginContact,bricked.world.SetContactListener(d),c=new b,c.SetSprite(bricked.ctx),c.SetDrawScale(bricked.SCALE),c.SetFillAlpha(.4),c.SetLineThickness(1),c.SetFlags(b.e_shapeBit|b.e_jointBit),bricked.world.SetDebugDraw(c)},bricked.startBall=function(){var a,b,c,d,e;return bricked.ballStartTime=bricked.getCurrentTime(),a=Box2D.Common.Math.b2Vec2,d=Math.random()*50+100,e=Math.random()*50+100,Math.random()>.5&&(d*=-1),e*=-1,c=new a(d,e),b=bricked.ball.GetPosition(),bricked.ball.ApplyForce(c,b)},bricked.killBall=function(){return bricked.paddleAi.ballDied(),bricked.didBallDie=!1,bricked.world.DestroyBody(bricked.ball),bricked.ball=bricked.createBall(),bricked.startBall()},bricked.update=function(){return bricked.world.Step(bricked.FRAME_RATE,bricked.VELOCITY_ITERATIONS,bricked.POSITION_ITERATIONS),bricked.world.DrawDebugData(),bricked.world.ClearForces(),bricked.didBallDie?bricked.killBall():bricked.getCurrentTime()-bricked.ballStartTime>6e4&&bricked.killBall(),Math.abs(bricked.ball.GetLinearVelocity().x)<.2?bricked.applyXForce(bricked.ball,1):Math.abs(bricked.ball.GetLinearVelocity().y)<.2&&bricked.applyYForce(bricked.ball,1),bricked.paddleAi.update(),bricked.stats.update(),requestAnimFrame(bricked.update)},bricked.init(),requestAnimFrame(bricked.update),bricked.startBall()